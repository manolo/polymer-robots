<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-image/iron-image.html">
<link rel="import" href="bower_components/paper-styles/paper-styles.html">
<link rel="import" href="bower_components/paper-badge/paper-badge.html">

<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="time-ago.html">

<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<link rel="import" href="bower_components/iron-localstorage/iron-localstorage.html">

<dom-module id="robots-ui">
  <template>
    <iron-localstorage name="robot-name" value={{name}}></iron-localstorage>

    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar id="navheader"  class="tall">
          <iron-image class="fit" id="coverimage" src="assets/robots-bg.jpg" sizing="cover"></iron-image>
          <div class="top">Robots Chat</div>
          <img class="middle" src="https://robohash.org/foo" />
          <div class="bottom">{{name}}</div>
        </paper-toolbar>

        <paper-menu selected="0" selectable="paper-icon-item">
          <paper-icon-item role="menuitem" value="Inbox" selected>
            <iron-icon icon="label" item-icon></iron-icon>
            Inbox
          </paper-icon-item>
          <paper-icon-item role="menuitem" value="Social">
            <iron-icon icon="label" item-icon></iron-icon>
            Social
          </paper-icon-item>
        </paper-menu>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar class="paper-header headerClass">
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="flex title">Inbox</div>
          <paper-icon-button icon="search"></paper-icon-button>
          <paper-icon-button icon="refresh"></paper-icon-button>
          <paper-icon-button icon="perm-identity" on-tap="_setup"></paper-icon-button>
          <paper-icon-button id="msg-icon" icon="speaker-notes"></paper-icon-button>
          <paper-badge id="count" for="msg-icon"></paper-badge>
        </paper-toolbar>
        <div class="layout vertical fit">
          <vaadin-grid id="grid" class="flex" rows="auto" items="{{items}}">
            <table>
              <colgroup>
                <col name="owner" width='40'/>
                <col name="owner" width='70'/>
                <col name="message" flex />
                <col name="ts" width='40'/>
              </colgroup>
              <thead hidden></thead>
            </table>
          </vaadin-grid>

          <paper-material elevation="5" class="layout horizontal write">
            <paper-input id='input' label="Type message..." class="flex"
                         allowedPattern=".+" preventInvalidInput on-keyup='_onkeyup'></paper-input>
            <paper-fab icon="send" on-tap="_send"></paper-fab>
          </paper-material>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>

    <paper-dialog id="setup" modal="true" class="layout vertical center">
       <h2>What's your Nickname</h2>
       <paper-input value={{name}}></paper-input>
       <paper-button dialog-confirm raised>Accept</paper-button>
    </paper-dialog>

  </template>
</dom-module>
<script>
  Polymer({
    is: "robots-ui",
    ready: function() {
      this.$.grid.columns[0].renderer = function(cell){
        var child = cell.element.children[0] || document.createElement('img');
        cell.element.appendChild(child);
        child.src = 'https://robohash.org/foo/' + cell.data;
      }
      this.$.grid.columns[3].renderer = function(cell){
        var child = cell.element.children[0] || document.createElement('time-ago');
        cell.element.appendChild(child);
        child.ts = cell.data;
      }
    },
    observers: [
      '_onitems(items.*)'
    ],
    _setup: function() {
      this.$.setup.open();
    },
    _send: function() {
      var val = this.$.input.value;
      if (val) {
        var msg = {owner: this.name, message: this.$.input.value, ts: Date.now()};
        this.push('items', msg);
        this.$.input.value = '';
        this.fire('new-msg', msg)
      }
    },
    _onkeyup(e) {
      if (e.keyCode == 13) {
        this._send();
      }
    },
    _onitems(items) {
      var l = this.$.grid.items.length;
      this.$.grid.size = l;
      this.$.grid.scrollToRow(l - 1);
      this.$.count.label = '' + l;
    }
  });
</script>
